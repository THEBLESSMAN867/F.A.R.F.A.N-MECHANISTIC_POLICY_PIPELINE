name: CI - Irrigation Synchronizer Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-irrigation-synchronizer:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
      
      - name: Run irrigation synchronizer integration tests
        run: |
          python -m pytest tests/integration/test_irrigation_synchronizer.py -v --tb=short --cov=src/farfan_pipeline/core/orchestrator/irrigation_synchronizer --cov-report=term-missing
        env:
          PYTHONPATH: ${{ github.workspace }}/src
      
      - name: Verify synchronization manifest structure
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path
          
          # Check if test artifacts exist
          artifacts_dir = Path('artifacts/test_synchronization')
          if not artifacts_dir.exists():
              print('⚠️  Test artifacts directory not found, skipping manifest verification')
              sys.exit(0)
          
          manifest_path = artifacts_dir / 'verification_manifest.json'
          if not manifest_path.exists():
              print('❌ verification_manifest.json not found')
              sys.exit(1)
          
          with open(manifest_path) as f:
              manifest = json.load(f)
          
          # Verify synchronization section exists
          if 'synchronization' not in manifest:
              print('❌ synchronization section missing from manifest')
              sys.exit(1)
          
          sync_data = manifest['synchronization']
          
          # Verify required fields
          required_fields = ['plan_id', 'integrity_hash', 'task_count', 'chunk_count']
          for field in required_fields:
              if field not in sync_data:
                  print(f'❌ Required field {field} missing from synchronization section')
                  sys.exit(1)
          
          # CI assertion: task_count == 300 (6 dimensions × 50 questions × 10 areas / 10)
          if sync_data['task_count'] != 300:
              print(f'❌ Expected task_count=300, got {sync_data[\"task_count\"]}')
              sys.exit(1)
          
          # Verify integrity hash can be recomputed
          print('✅ Synchronization manifest structure verified')
          print(f'   plan_id: {sync_data[\"plan_id\"]}')
          print(f'   integrity_hash: {sync_data[\"integrity_hash\"]}')
          print(f'   task_count: {sync_data[\"task_count\"]}')
          print(f'   chunk_count: {sync_data[\"chunk_count\"]}')
          "
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: irrigation-synchronizer-test-artifacts
          path: |
            artifacts/test_synchronization/
            .coverage
          retention-days: 7
