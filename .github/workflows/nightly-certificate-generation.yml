name: Nightly Certificate Generation

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  generate-certificates:
    name: Generate and Archive Nightly Certificates
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
          
      - name: Run all contract tests
        run: |
          python -m pytest farfan_core/farfan_core/contracts/tests -v
          
      - name: Generate certificates
        run: |
          python scripts/bundle_release_certificates.py
          
      - name: Get timestamp
        id: timestamp
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        
      - name: Create nightly release tag
        run: |
          RELEASE_NAME="nightly-${{ steps.timestamp.outputs.date }}"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          
      - name: Upload nightly certificates
        uses: actions/upload-artifact@v4
        with:
          name: nightly-certificates-${{ steps.timestamp.outputs.date }}
          path: release_certificates_*/
          retention-days: 30
          
      - name: Generate health report
        run: |
          echo "# Nightly Contract Health Report" > health_report.md
          echo "Date: ${{ steps.timestamp.outputs.date }}" >> health_report.md
          echo "" >> health_report.md
          echo "## Test Results" >> health_report.md
          python -m pytest farfan_core/farfan_core/contracts/tests -v --tb=no >> health_report.md || true
          echo "" >> health_report.md
          echo "## Certificate Bundle" >> health_report.md
          cat release_certificates_*/README.md >> health_report.md || true
          
      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ steps.timestamp.outputs.date }}
          path: health_report.md
          retention-days: 30
          
  validate-historical-certificates:
    name: Validate Historical Certificate Integrity
    runs-on: ubuntu-latest
    needs: generate-certificates
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download latest certificates
        uses: actions/download-artifact@v4
        with:
          pattern: nightly-certificates-*
          merge-multiple: true
          path: historical_certs/
          
      - name: Validate certificate signatures
        run: |
          echo "Validating certificate bundle integrity..."
          for manifest in historical_certs/*/MANIFEST.json; do
            if [ -f "$manifest" ]; then
              echo "Checking: $manifest"
              python3 -c "
          import json
          import hashlib
          import sys
          
          with open('$manifest', 'r') as f:
              data = json.load(f)
          
          signature = data.pop('signature', None)
          content = json.dumps(data, sort_keys=True, indent=2)
          computed = hashlib.sha256(content.encode()).hexdigest()
          
          if signature == computed:
              print('✅ Signature valid: $manifest')
          else:
              print('❌ Signature invalid: $manifest')
              sys.exit(1)
              "
            fi
          done
          
      - name: Archive validation results
        run: |
          echo "Historical certificate validation completed at $(date)" > validation_log.txt
          echo "All signatures verified successfully" >> validation_log.txt
