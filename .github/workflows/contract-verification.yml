name: Contract Verification Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.12'
  COVERAGE_THRESHOLD: 90

jobs:
  contract-tests:
    name: Run 15 Contract Test Suites
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
          
      - name: Install mutation testing tools
        run: |
          pip install mutmut coverage[toml]
          
      - name: Run contract test suite
        run: |
          python -m pytest farfan_core/farfan_core/contracts/tests -v \
            --tb=short \
            --color=yes \
            --junit-xml=test-results/contract-tests.xml
            
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: contract-test-results
          path: test-results/
          retention-days: 30
          
  verify-all-contracts:
    name: Verify All Contracts Script
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: contract-tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
          
      - name: Run verify_all_contracts.py
        run: |
          cd farfan_core/farfan_core/contracts
          python verify_all_contracts.py
          
      - name: Upload certificate artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: contract-certificates
          path: '*.json'
          retention-days: 90
          
  mutation-testing:
    name: Mutation Testing (90% Coverage)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: contract-tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
          
      - name: Install mutation testing tools
        run: |
          pip install mutmut coverage[toml]
          
      - name: Run mutation testing suite
        run: |
          python scripts/run_mutation_suite.py
        continue-on-error: true
        
      - name: Generate coverage report
        run: |
          python -m pytest farfan_core/farfan_core/contracts/tests \
            --cov=farfan_core/farfan_core/contracts \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
            
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: contracts
          name: contract-coverage
          fail_ci_if_error: false
          
      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30
          
      - name: Check coverage threshold
        run: |
          coverage report --fail-under=${{ env.COVERAGE_THRESHOLD }}
          
      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-report
          path: mutation_report.txt
          retention-days: 30
          
  generate-release-certificates:
    name: Generate Cryptographic Release Certificates
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [verify-all-contracts, mutation-testing]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
          
      - name: Generate release certificate bundle
        run: |
          python scripts/bundle_release_certificates.py
          
      - name: List generated certificates
        run: |
          ls -lh release_certificates_*/
          
      - name: Upload release certificate bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-certificates-${{ github.sha }}
          path: release_certificates_*/
          retention-days: 365
          
      - name: Create release notes
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "## Contract Verification Release" > release_notes.md
          echo "SHA: ${{ github.sha }}" >> release_notes.md
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release_notes.md
          echo "" >> release_notes.md
          cat release_certificates_*/README.md >> release_notes.md
          
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          name: release-notes
          path: release_notes.md
          retention-days: 365
          
  contract-verification-summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [contract-tests, verify-all-contracts, mutation-testing]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Generate verification summary
        run: |
          echo "# Contract Verification Pipeline Summary" > summary.md
          echo "" >> summary.md
          echo "**Workflow Run:** ${{ github.run_number }}" >> summary.md
          echo "**Commit SHA:** ${{ github.sha }}" >> summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> summary.md
          echo "**Triggered by:** ${{ github.event_name }}" >> summary.md
          echo "" >> summary.md
          echo "## Job Status" >> summary.md
          echo "- Contract Tests: ${{ needs.contract-tests.result }}" >> summary.md
          echo "- Verify All Contracts: ${{ needs.verify-all-contracts.result }}" >> summary.md
          echo "- Mutation Testing: ${{ needs.mutation-testing.result }}" >> summary.md
          echo "" >> summary.md
          echo "## Artifacts Generated" >> summary.md
          echo "Check the artifacts section for:" >> summary.md
          echo "- Contract test results (JUnit XML)" >> summary.md
          echo "- Contract certificates (JSON)" >> summary.md
          echo "- Coverage reports (HTML + XML)" >> summary.md
          echo "- Mutation testing reports" >> summary.md
          
          cat summary.md
          
      - name: Comment PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
