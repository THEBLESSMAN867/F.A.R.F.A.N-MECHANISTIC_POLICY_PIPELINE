# =============================================================================
# CONFIGURACIÓN DE CALIBRACIÓN PARA CausalExtractor (extendida con Cuestionario)
# Sistema FARFAN 3.2 - CDAF
# =============================================================================
# Foco: Insumos → Actividades → Productos → Resultados → Impactos → Causalidad
# + Evaluación Macro/Meso/Micro y Género (DIM01–DIM04)
# Fecha: 2025-11-03 | Versión: 2.2.0
# =============================================================================

causal_extractor:
  version: "2.2.0"
  locale: "es-CO"
  inherits_from: "2.1.0"
  description: "Extracción causal + evaluación estructurada (macro/meso/micro) para PDM de Colombia."
  default_context_window: 50
  max_context_window: 120
  case_insensitive: true
  unicode_normalization: "NFC"

  # ---------------------------------------------------------------------------
  # CAPAS SEMÁNTICAS Y ESTRATEGIA DE EMBEDDINGS (para búsquedas híbridas)
  # ---------------------------------------------------------------------------
  semantic_layers:
    disambiguation:
      entity_linker: "spaCy_es_core_news_lg"
      confidence_threshold: 0.72
    embedding_strategy:
      model: "multilingual-e5-base"
      dimension: 768
      hybrid:
        bm25: true
        fusion: "RRF"
  # (Definición tomada y armonizada con el monolito.) :contentReference[oaicite:1]{index=1}

  # ---------------------------------------------------------------------------
  # EVALUACIÓN MACRO (visión integral del PDM)
  # ---------------------------------------------------------------------------
  macro_assessment:
    question_id: "MACRO_1"
    text: "¿El Plan de Desarrollo presenta una visión integral y coherente que articula todos los clusters y dimensiones?"
    aggregation_method: "holistic_assessment"
    scoring_modality: "MACRO_HOLISTIC"
    clusters: ["CLUSTER_1","CLUSTER_2","CLUSTER_3","CLUSTER_4"]
    patterns:
      - {type: "narrative_coherence", priority: 1, description: "Evaluar coherencia narrativa global"}
      - {type: "cross_cluster_integration", priority: 1, description: "Verificar integración entre clusters"}
      - {type: "long_term_vision", priority: 2, description: "Visión de largo plazo/transformación"}
    fallback:
      condition: "always_true"
      pattern: "MACRO_AMBIGUO"
      priority: 999
  # (Estructura y redactado concordante con el bloque MACRO.) :contentReference[oaicite:2]{index=2}

  # ---------------------------------------------------------------------------
  # EVALUACIÓN MESO (integración por cluster)
  # ---------------------------------------------------------------------------
  meso_assessment:
    modality: "MESO_INTEGRATION"
    items:
      - cluster_id: "CLUSTER_1"
        policy_areas: ["P2","P3","P7"]
        aggregation_method: "weighted_average"
        patterns: [{type:"cross_reference"},{type:"coherence"}]
        question_id: "MESO_1"
      - cluster_id: "CLUSTER_2"
        policy_areas: ["P1","P5","P6"]
        aggregation_method: "weighted_average"
        patterns: [{type:"cross_reference"},{type:"coherence"}]
        question_id: "MESO_2"
      - cluster_id: "CLUSTER_3"
        policy_areas: ["P4","P8"]
        aggregation_method: "weighted_average"
        patterns: [{type:"cross_reference"},{type:"coherence"}]
        question_id: "MESO_3"
      - cluster_id: "CLUSTER_4"
        policy_areas: ["P9","P10"]
        aggregation_method: "weighted_average"
        patterns: [{type:"cross_reference"},{type:"coherence"}]
        question_id: "MESO_4"
  # (Paridad con definición de preguntas MESO.) :contentReference[oaicite:3]{index=3}

  # ---------------------------------------------------------------------------
  # EVALUACIÓN MICRO (DIM01–DIM04 en Género; extensible)
  # ---------------------------------------------------------------------------
  micro_assessment:
    # —DIM01: Diagnóstico con línea base y fuentes—
    D1_Q1:
      base_slot: "D1-Q1"
      cluster_id: "CL02"
      dimension_id: "DIM01"
      text: "¿El diagnóstico presenta datos numéricos útiles como línea base (VBG, participación, brecha salarial) con año y fuentes?"
      scoring_modality: "TYPE_A"
      expected_elements:
        - {type: "cobertura_territorial_especificada", required: true}
        - {type: "fuentes_oficiales", minimum: 2}
        - {type: "indicadores_cuantitativos", minimum: 3}
        - {type: "series_temporales_años", minimum: 3}
      validations:
        buscar_indicadores_cuantitativos:
          minimum_required: 3
          patterns: ["\\d+%","\\d+\\s*por\\s*\\d+","tasa de","índice de","cobertura de"]
          specificity: "HIGH"
        cobertura:
          minimum_required: 1
          patterns: ["departamental","municipal","urbano","rural","territorial","poblacional"]
          specificity: "HIGH"
        series_temporales:
          minimum_years: 3
          patterns: ["20\\d{2}","año","periodo","histórico","serie"]
          specificity: "MEDIUM"
        unidades_medicion:
          minimum_required: 2
          patterns: ["por 100.000","por 1.000","%","porcentaje","tasa","razón"]
          specificity: "MEDIUM"
        verificar_fuentes:
          minimum_required: 2
          patterns: ["fuente:","según","datos de","DANE","DNP","SISPRO","SIVIGILA","Ministerio"]
          specificity: "MEDIUM"
      patterns_ref: ["PAT-Q001-000" ,"...","PAT-Q001-013"]
    # (Campos y patrones replicados y compactados del Q001.) :contentReference[oaicite:4]{index=4}

    # —DIM01: Brecha, sesgos y vacíos—
    D1_Q2:
      base_slot: "D1-Q2"
      scoring_modality: "TYPE_B"
      required_elements:
        - "cuantificacion_brecha"
        - "sesgos_reconocidos"
        - "vacios_explicitos"
      failure_contract:
        abort_if: ["missing_required_element","incomplete_text"]
        emit_code: "ABORT-Q002-REQ"
      patterns_ref: ["PAT-Q002-000","...","PAT-Q002-008"]
      text: "¿Se cuantifica la brecha y se reconocen subregistro/vacíos/limitaciones?"
    # (Contratos de falla y categorías.) :contentReference[oaicite:5]{index=5}

    # —DIM01: Asignación y trazabilidad presupuestal—
    D1_Q3:
      base_slot: "D1-Q3"
      scoring_modality: "TYPE_B"
      required_elements: ["asignacion_explicita","suficiencia_justificada","trazabilidad_ppi_bpin"]
      patterns_ref: ["PAT-Q003-000","...","PAT-Q003-008"]
      text: "¿Existen recursos PPI/BPIN, trazadores de género y análisis de suficiencia?"
    # (PPI, BPIN, COP, fuentes.) :contentReference[oaicite:6]{index=6}

    # —DIM01: Capacidad institucional, datos y cuellos de botella—
    D1_Q4:
      base_slot: "D1-Q4"
      scoring_modality: "TYPE_B"
      required_elements: ["cuellos_botella","datos_sistemas","gobernanza","procesos","talento_humano"]
      patterns_ref: ["PAT-Q004-000","...","PAT-Q004-008"]
      text: "¿Se describen capacidades, rutas de atención, sistemas de registro y barreras?"
    # (Secretaría/Comisaría/Observatorio/rutas.) :contentReference[oaicite:7]{index=7}

    # —DIM01: Marco legal y restricciones—
    D1_Q5:
      base_slot: "D1-Q5"
      scoring_modality: "TYPE_E"
      required_elements: ["coherencia_demostrada","restricciones_legales","restricciones_presupuestales","restricciones_temporales"]
      patterns_ref: ["PAT-Q005-000","...","PAT-Q005-009"]
      text: "¿Se justifica el alcance con marco legal (Ley 1257, CONPES), y límites fiscales/temporales?"
    # (Presencia explícita de restricciones.) :contentReference[oaicite:8]{index=8}

    # —DIM02: Plan de acción tabular (responsable, producto, cronograma, costo)—
    D2_Q1:
      base_slot: "D2-Q1"
      scoring_modality: "TYPE_A"
      required_columns: ["responsable","producto/entregable","cronograma","costo/presupuesto","formato_tabular"]
      patterns_ref: ["PAT-Q006-000","...","PAT-Q006-006"]
      text: "¿Las actividades están en tabla con responsable, producto, cronograma y costo?"
    # (Estructura tabla, ejecutor y anexos.) :contentReference[oaicite:9]{index=9}

    # —DIM02: Instrumento, población objetivo y lógica causal explícita—
    D2_Q2:
      base_slot: "D2-Q2"
      scoring_modality: "TYPE_A"
      required_elements: ["instrumento_especificado","logica_causal_explicita","poblacion_objetivo_definida"]
      patterns_ref: ["PAT-Q007-000","...","PAT-Q007-008"]
      text: "¿Se detalla el instrumento, la población objetivo y la lógica causal de las actividades?"
    # (Mediante/a través de… + con el fin de…) :contentReference[oaicite:10]{index=10}

    # —DIM02: Causa raíz y vínculo diagnóstico-actividad—
    D2_Q3:
      base_slot: "D2-Q3"
      scoring_modality: "TYPE_A"
      required_elements: ["aborda_causa_raiz","vinculo_diagnostico_actividad"]
      patterns_ref: ["PAT-Q008-000","...","PAT-Q008-006"]
      text: "¿La actividad atiende causas estructurales identificadas?"
    # (Árbol de problemas y determinantes.) :contentReference[oaicite:11]{index=11}

    # —DIM02: Riesgos y mitigación—
    D2_Q4:
      base_slot: "D2-Q4"
      scoring_modality: "TYPE_A"
      required_elements: ["riesgos_identificados","mitigacion_propuesta"]
      patterns_ref: ["PAT-Q009-000","...","PAT-Q009-008"]
      text: "¿Se identifican riesgos (revictimización, baja participación) y medidas de mitigación?"
    # (Plan de contingencia / monitoreo de riesgos.) :contentReference[oaicite:12]{index=12}

    # —DIM02: Complementariedad y secuenciación—
    D2_Q5:
      base_slot: "D2-Q5"
      scoring_modality: "TYPE_A"
      required_elements: ["complementariedad_explicita","secuenciacion_logica"]
      patterns_ref: ["PAT-Q010-000","...","PAT-Q010-006"]
      text: "¿Hay sinergias y fases lógicas entre actividades (prevención, atención, justicia)?"
    # (No redundancia; prerrequisitos.) :contentReference[oaicite:13]{index=13}

    # —DIM03: Indicadores de producto—LB, meta, fuente—
    D3_Q1:
      base_slot: "D3-Q1"
      scoring_modality: "TYPE_A"
      required_elements: ["fuente_verificacion","linea_base_producto","meta_cuantitativa"]
      patterns_ref: ["PAT-Q011-000","...","PAT-Q011-009"]
      text: "¿Cada indicador de producto incluye LB, meta y fuente de verificación?"
    # (Ficha/Anexo/listados/actas.) :contentReference[oaicite:14]{index=14}

    # —DIM03: Proporcionalidad y dosificación—
    D3_Q2:
      base_slot: "D3-Q2"
      scoring_modality: "TYPE_A"
      required_elements: ["dosificacion_definida","proporcionalidad_meta_brecha"]
      patterns_ref: ["PAT-Q012-000","...","PAT-Q012-008"]
      text: "¿La meta es proporcional a la brecha y con intensidad/frecuencia definidas?"
    # (Cobertura vs. universo; costo-efectividad.) :contentReference[oaicite:15]{index=15}

    # —DIM03: Trazabilidad org-presupuestal—
    D3_Q3:
      base_slot: "D3-Q3"
      scoring_modality: "TYPE_A"
      required_elements: ["trazabilidad_organizacional","trazabilidad_presupuestal"]
      patterns_ref: ["PAT-Q013-000","...","PAT-Q013-006"]
      text: "¿Todo producto está enlazado a BPIN/PPI y dependencia responsable?"
    # (Corresponsabilidad/alianzas.) :contentReference[oaicite:16]{index=16}

    # —DIM03: Factibilidad—
    D3_Q4:
      base_slot: "D3-Q4"
      scoring_modality: "TYPE_A"
      required_elements: ["coherencia_recursos","factibilidad_tecnica","realismo_plazos"]
      patterns_ref: ["PAT-Q014-000","...","PAT-Q014-005"]
      text: "¿Metas factibles con capacidad operativa y plazos realistas?"
    # (Ambicioso pero alcanzable.) :contentReference[oaicite:17]{index=17}

    # —DIM03: Vínculo Producto→Resultado (mecanismo)—
    D3_Q5:
      base_slot: "D3-Q5"
      scoring_modality: "TYPE_A"
      required_elements: ["conexion_producto_resultado","mecanismo_causal_explicito"]
      patterns_ref: ["PAT-Q015-000","...","PAT-Q015-005"]
      text: "¿Se explica el mecanismo que conecta productos con resultados?"
    # (Variable intermedia/mediador.) :contentReference[oaicite:18]{index=18}

    # Nota: DIM04 (resultados/outcomes) se integra con umbrales de horizonte, LB y metas,
    # coherente con D4-Q1+ (no reproducido completo aquí por extensión del monolito 305 ítems). :contentReference[oaicite:19]{index=19}

  # ---------------------------------------------------------------------------
  # MODALIDADES DE PUNTAJE Y NIVELES
  # ---------------------------------------------------------------------------
  scoring:
    micro_levels:
      - {level: "EXCELENTE", color: "green",  min_score: 0.85}
      - {level: "BUENO",     color: "blue",   min_score: 0.70}
      - {level: "ACEPTABLE", color: "yellow", min_score: 0.55}
      - {level: "INSUFICIENTE", color: "red", min_score: 0.0}
    modalities:
      TYPE_A: {description: "Count 4 elements and scale to 0-3", max_score: 3}
      TYPE_B: {description: "Count up to 3 elements, each worth 1 point", max_score: 3}
      TYPE_C: {description: "Count 2 elements and scale to 0-3", max_score: 3}
      TYPE_D: {description: "Calculate ratio and apply thresholds", max_score: 3}
      TYPE_E: {description: "Boolean presence check"}
      TYPE_F: {description: "Semantic matching with cosine similarity", max_score: 3}
    modality_definitions:
      TYPE_A: {aggregation: "presence_threshold", threshold: 0.7, failure_code: "F-A-MIN"}
      TYPE_B: {aggregation: "binary_sum",         max_score: 3,  failure_code: "F-B-MIN"}
      TYPE_C: {aggregation: "presence_threshold", threshold: 0.5, failure_code: "F-C-MIN"}
      TYPE_D: {aggregation: "weighted_sum",       weights: [0.4,0.3,0.3], failure_code: "F-D-MIN"}
      TYPE_E: {aggregation: "binary_presence",    failure_code: "F-E-MIN"}
      TYPE_F: {aggregation: "normalized_continuous", normalization: "minmax", failure_code: "F-F-MIN"}
  # (Tomado literalmente de modalidades/definiciones.) :contentReference[oaicite:20]{index=20}

  # ---------------------------------------------------------------------------
  # CLUSTERS, ÁREAS Y EVIDENCIA REQUERIDA (extracto)
  # ---------------------------------------------------------------------------
  clusters_policy_areas:
    CL04:
      policy_area_ids: ["PA09","PA10"]
      required_evidence_keys:
        - official_stats
        - official_documents
        - monitoring_tables
        - third_party_research
      notes: "Incluye crisis de derechos en PPL y migración transfronteriza."
  # (Matriz de CL04 y llaves de evidencia.) :contentReference[oaicite:21]{index=21}

  # ---------------------------------------------------------------------------
  # OBSERVABILIDAD Y TELEMETRÍA (para auditoría y M&E)
  # ---------------------------------------------------------------------------
  observability:
    telemetry_schema:
      logs:
        format: "jsonl"
        fields: ["timestamp","question_id","pattern_id","matched_text","confidence","trace_id","ruleset_hash"]
      metrics:
        - {name: "pattern_match_count", level: "MICRO", aggregation: "sum"}
        - {name: "precision_local", level: "MICRO", aggregation: "p95"}
        - {name: "recall_local", level: "MICRO", aggregation: "p50"}
    integrity:
      monolith_hash: "de52721917492cac3e6c548dc7457d9de68b66183bebdaf825e090e3bbdba6d0"
      ruleset_hash:  "9daaaf91c4c9bc90c3212c196c719f7120fca4c3b2b7875851c3e18e428e600a"
      question_count: {macro: 1, meso: 4, micro: 300, total: 305}
  # (Campos de integridad y esquema de observabilidad.) :contentReference[oaicite:22]{index=22}

  # ---------------------------------------------------------------------------
  # PUENTES ENTRE CADENA CAUSAL Y EVALUACIÓN (reglas de consistencia)
  # ---------------------------------------------------------------------------
  causal_evaluation_bridges:
    # Vincula clases detectadas con checks del cuestionario
    link_rules:
      - when: ["Productos","Causalidad","Resultados"]
        then_require: ["D3_Q5"]     # mecanismo explícito Producto→Resultado
      - when: ["Actividades"]
        then_require: ["D2_Q1","D2_Q2","D2_Q3","D2_Q4","D2_Q5"]
      - when: ["Insumos"]
        then_require: ["D1_Q1","D1_Q2"]
      - when: ["Impactos"]
        then_require: ["MACRO_1"]   # visión de largo plazo y coherencia integral
    scoring_hooks:
      # bonus si hay trazabilidad BPIN/PPI y corresponsabilidad
      - source: "D3_Q3"
        target: ["Productos","Resultados"]
        bonus: 0.06
      # penalización si hay metas sin LB/fuente
      - source: "D3_Q1"
        target: ["Productos"]
        penalty_if_missing: 0.08

  # ---------------------------------------------------------------------------
  # PRUEBAS MÍNIMAS (ampliadas con checks del cuestionario)
  # ---------------------------------------------------------------------------
  tests:
    - name: "macro_integral"
      text: "El plan articula todos los clusters con visión 2024–2027 y metas ODS."
      expect_macro: {question_id: "MACRO_1", min_score: 0.70}
    - name: "meso_seguridad_paz_integracion"
      text: "Las políticas P2–P3–P7 se referencian mutuamente en el cluster Seguridad y Paz."
      expect_meso: {question_id: "MESO_1"}
    - name: "d1q1_genero_lb_fuentes"
      text: "Según DANE y Medicina Legal, 2021–2023: tasa de VBG 2.1 por 1.000; participación 37%; brecha salarial 14%."
      expect_micro: {slot: "D1_Q1", min_score: 0.70}
    - name: "d2q1_tabla_4_columnas"
      text: "Tabla de plan de acción: Responsable, Producto, Cronograma, Costo."
      expect_micro: {slot: "D2_Q1", min_score: 0.70}
    - name: "d3q5_mecanismo_explicito"
      text: "Capacitar + capital semilla → aumenta ingreso promedio; mecanismo: habilidades+activos."
      expect_micro: {slot: "D3_Q5", min_score: 0.70}
