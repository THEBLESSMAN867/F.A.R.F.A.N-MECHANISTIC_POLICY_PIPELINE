<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
     viewBox="0 0 1200 1400" width="1200" height="1400">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #333; }
      .subtitle { font: 16px sans-serif; fill: #666; }
      .actor { font: bold 14px sans-serif; fill: #fff; }
      .message { font: 12px sans-serif; fill: #333; }
      .note { font: 12px sans-serif; fill: #444; }
      .box { fill: #4A90E2; stroke: #2E5C8A; stroke-width: 2; }
      .lifeline { stroke: #666; stroke-width: 2; stroke-dasharray: 5,5; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .return-arrow { stroke: #666; stroke-width: 1.5; fill: none; marker-end: url(#arrowhead-return); stroke-dasharray: 5,3; }
      .note-box { fill: #FFF4CC; stroke: #CCAA00; stroke-width: 1; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="arrowhead-return" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#666" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="600" y="40" class="title" text-anchor="middle">Irrigation Synchronization Sequence</text>
  <text x="600" y="65" class="subtitle" text-anchor="middle">Chunk → Question → Task → Plan Flow</text>
  
  <!-- Actors -->
  <rect x="50" y="100" width="160" height="50" class="box" rx="5"/>
  <text x="130" y="130" class="actor" text-anchor="middle">Orchestrator</text>
  
  <rect x="270" y="100" width="160" height="50" class="box" rx="5"/>
  <text x="350" y="130" class="actor" text-anchor="middle">IrrigationSync</text>
  
  <rect x="490" y="100" width="160" height="50" class="box" rx="5"/>
  <text x="570" y="130" class="actor" text-anchor="middle">Questionnaire</text>
  
  <rect x="710" y="100" width="160" height="50" class="box" rx="5"/>
  <text x="790" y="130" class="actor" text-anchor="middle">Document</text>
  
  <rect x="930" y="100" width="160" height="50" class="box" rx="5"/>
  <text x="1010" y="130" class="actor" text-anchor="middle">ExecutionPlan</text>
  
  <!-- Lifelines -->
  <line x1="130" y1="150" x2="130" y2="1350" class="lifeline"/>
  <line x1="350" y1="150" x2="350" y2="1350" class="lifeline"/>
  <line x1="570" y1="150" x2="570" y2="1350" class="lifeline"/>
  <line x1="790" y1="150" x2="790" y2="1350" class="lifeline"/>
  <line x1="1010" y1="150" x2="1010" y2="1350" class="lifeline"/>
  
  <!-- Phase 1: Ingestion -->
  <rect x="20" y="180" width="180" height="40" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2" rx="3"/>
  <text x="110" y="205" class="note" font-weight="bold">Phase 1: Ingestion</text>
  
  <path d="M 130 230 L 790 230" class="arrow"/>
  <text x="460" y="225" class="message">process_pdf()</text>
  
  <path d="M 790 260 L 130 260" class="return-arrow"/>
  <text x="460" y="255" class="message">chunks[60]</text>
  
  <!-- Phase 1.5: Synchronization Init -->
  <rect x="20" y="290" width="220" height="40" fill="#FFF9C4" stroke="#FBC02D" stroke-width="2" rx="3"/>
  <text x="130" y="315" class="note" font-weight="bold">Phase 1.5: Synchronization</text>
  
  <path d="M 130 340 L 350 340" class="arrow"/>
  <text x="240" y="335" class="message">IrrigationSynchronizer()</text>
  
  <rect x="380" y="370" width="220" height="60" class="note-box" rx="3"/>
  <text x="490" y="390" class="note" text-anchor="middle">Generate UUID4</text>
  <text x="490" y="408" class="note" text-anchor="middle">correlation_id</text>
  <text x="490" y="425" class="note" text-anchor="middle">Log initialization</text>
  
  <!-- Question Extraction -->
  <path d="M 350 450 L 570 450" class="arrow"/>
  <text x="460" y="445" class="message">extract_questions()</text>
  
  <rect x="600" y="475" width="180" height="80" class="note-box" rx="3"/>
  <text x="690" y="495" class="note" text-anchor="middle">Parse blocks:</text>
  <text x="690" y="513" class="note" text-anchor="middle">D1_Q01...D1_Q50</text>
  <text x="690" y="531" class="note" text-anchor="middle">D2_Q01...D2_Q50</text>
  <text x="690" y="549" class="note" text-anchor="middle">...D6_Q50</text>
  
  <path d="M 570 575 L 350 575" class="return-arrow"/>
  <text x="460" y="570" class="message">questions[300]</text>
  
  <!-- Chunk Access -->
  <path d="M 350 605 L 790 605" class="arrow"/>
  <text x="570" y="600" class="message">get_chunks()</text>
  
  <path d="M 790 635 L 350 635" class="return-arrow"/>
  <text x="570" y="630" class="message">chunks[60]</text>
  
  <!-- Task Generation -->
  <rect x="300" y="665" width="300" height="40" fill="#E1F5FE" stroke="#039BE5" stroke-width="2" rx="3"/>
  <text x="450" y="690" class="note" font-weight="bold" text-anchor="middle">Task Generation Loop</text>
  
  <rect x="270" y="720" width="360" height="140" class="note-box" rx="3"/>
  <text x="450" y="740" class="note" text-anchor="middle" font-weight="bold">for question in questions[300]:</text>
  <text x="450" y="760" class="note" text-anchor="middle">  for policy_area in [PA01...PA10]:</text>
  <text x="450" y="780" class="note" text-anchor="middle">    for chunk in chunks[60]:</text>
  <text x="450" y="800" class="note" text-anchor="middle">      task_id = f"{q}_{pa}_{c}"</text>
  <text x="450" y="820" class="note" text-anchor="middle">      Task(...)</text>
  <text x="450" y="845" class="note" text-anchor="middle" font-style="italic">= 300 × 10 × 60 = 180,000 tasks</text>
  
  <!-- Metrics -->
  <rect x="20" y="880" width="160" height="40" fill="#FCE4EC" stroke="#E91E63" stroke-width="2" rx="3"/>
  <text x="100" y="905" class="note" font-weight="bold">Prometheus Metrics</text>
  
  <path d="M 350 930 L 130 930" class="arrow"/>
  <text x="240" y="925" class="message">tasks_constructed++</text>
  
  <!-- Integrity Hashing -->
  <rect x="270" y="960" width="300" height="40" fill="#F3E5F5" stroke="#9C27B0" stroke-width="2" rx="3"/>
  <text x="420" y="985" class="note" font-weight="bold" text-anchor="middle">Integrity Hashing</text>
  
  <rect x="280" y="1015" width="280" height="80" class="note-box" rx="3"/>
  <text x="420" y="1035" class="note" text-anchor="middle">task_data = json.dumps(tasks)</text>
  <text x="420" y="1053" class="note" text-anchor="middle">hash = blake3(task_data)</text>
  <text x="420" y="1071" class="note" text-anchor="middle">plan_id = f"plan_{hash[:16]}"</text>
  
  <!-- Plan Creation -->
  <path d="M 350 1110 L 1010 1110" class="arrow"/>
  <text x="680" y="1105" class="message">ExecutionPlan(...)</text>
  
  <rect x="840" y="1135" width="340" height="100" class="note-box" rx="3"/>
  <text x="1010" y="1155" class="note" text-anchor="middle">plan_id: "plan_a1b2c3d4..."</text>
  <text x="1010" y="1173" class="note" text-anchor="middle">tasks: tuple[Task, ...] (180K)</text>
  <text x="1010" y="1191" class="note" text-anchor="middle">integrity_hash: "a1b2c3d4..."</text>
  <text x="1010" y="1209" class="note" text-anchor="middle">correlation_id: uuid4</text>
  <text x="1010" y="1227" class="note" text-anchor="middle">chunk_count: 60</text>
  
  <path d="M 1010 1250 L 350 1250" class="return-arrow"/>
  <text x="680" y="1245" class="message">plan</text>
  
  <path d="M 350 1280 L 130 1280" class="return-arrow"/>
  <text x="240" y="1275" class="message">execution_plan</text>
  
  <!-- Final Note -->
  <rect x="20" y="1310" width="1160" height="30" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2" rx="3"/>
  <text x="600" y="1330" class="note" text-anchor="middle" font-weight="bold">
    Pipeline proceeds to Phase 2 with deterministic execution plan
  </text>
  
</svg>
