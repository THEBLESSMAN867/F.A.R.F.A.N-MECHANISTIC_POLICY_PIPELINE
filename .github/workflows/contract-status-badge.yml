name: Contract Status Badge

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Contract Verification Pipeline"]
    types:
      - completed

jobs:
  update-badge:
    name: Update Contract Status Badge
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
          
      - name: Count passing contracts
        id: count
        run: |
          python -m pytest farfan_core/farfan_core/contracts/tests --collect-only -q 2>/dev/null | grep "test session starts" || true
          TOTAL_TESTS=$(python -m pytest farfan_core/farfan_core/contracts/tests --collect-only -q 2>&1 | grep -oP '\d+(?= tests collected)' || echo "15")
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          
      - name: Run quick contract verification
        id: verify
        run: |
          if python -m pytest farfan_core/farfan_core/contracts/tests -q --tb=no; then
            echo "status=passing" >> $GITHUB_OUTPUT
            echo "color=brightgreen" >> $GITHUB_OUTPUT
          else
            echo "status=failing" >> $GITHUB_OUTPUT
            echo "color=red" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        
      - name: Create badge JSON
        run: |
          cat > contract-badge.json << EOF
          {
            "schemaVersion": 1,
            "label": "contracts",
            "message": "${{ steps.count.outputs.total }}/15 ${{ steps.verify.outputs.status }}",
            "color": "${{ steps.verify.outputs.color }}"
          }
          EOF
          
      - name: Upload badge data
        uses: actions/upload-artifact@v4
        with:
          name: contract-badge
          path: contract-badge.json
          retention-days: 1
